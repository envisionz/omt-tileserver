version: "3"

volumes:
  pgdata:
    external: true
    name: omt-tileserver-pgdata

networks:
  db:
  tileservers:
  web:

services:
  omt-postgres:
    image: "openmaptiles/postgis:5.3"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - db

  postserve:
    image: "openmaptiles/openmaptiles-tools:5.3"
    command: "postserve /omt-layers/openmaptiles.yaml --verbose --serve=http://postserve:8080 --port 8080"
    environment:
      PGDATABASE: openmaptiles
      PGUSER: openmaptiles
      PGPASSWORD: openmaptiles
      PGHOST: omt-postgres
      PGPORT: 5432
    volumes:
      - ./openmaptiles:/omt-layers
    networks:
      - db
      - tileservers
  
  tileserver:
    image: envisionz/tileserver
    environment:
      POSTSERVE_HOST: http://postserve:8080
      TILE_FORMAT: webp
    networks:
      - tileservers

  cache:
    image: envisionz/varnish
    environment:
      VARNISH_SIZE: 1G
    ports:
      - "127.0.0.1:8181:80"
    networks:
      - tileservers
