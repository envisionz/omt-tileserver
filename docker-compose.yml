version: "3"

volumes:
  pgdata:
  data-status:
  osm-status:
  omt-import:
  omt-cache:
  omt-expired-tiles:

networks:
  db:
  tileservers:

services:
  postgres:
    image: "openmaptiles/postgis:5.3"
    env_file: .env-pg
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - db
  
  import-data:
    image: "openmaptiles/import-data:5.3"
    command: >
      /bin/sh -c "([ -f /status/data-import ] || ./import_data.sh) && touch /status/data-import"
    env_file: .env
    restart: on-failure
    volumes: 
      - data-status:/status
    networks:
      - db
  
  osm-update:
    image: "envisionz/omt-tools"
    command: "envnz-dl-import-update"
    env_file: .env
    volumes:
      - data-status:/status_data:ro
      - osm-status:/status_osm
      - omt-cache:/cache
      - omt-import:/import
      - omt-expired-tiles:/expired_tiles
    networks:
      - db

  postserve:
    image: "envisionz/omt-tools"
    command: >
      /bin/bash -c "pgwait 
      && until [ -f /status/osm-import ]; do sleep 2; done
      && postserve openmaptiles.yaml --verbose --serve=http://postserve:8080 --port 8080"
    env_file: .env
    volumes:
      - osm-status:/status
    networks:
      - db
      - tileservers
  
  tileserver:
    image: envisionz/tileserver
    environment:
      POSTSERVE_HOST: http://postserve:8080
      TILE_FORMAT: png
    volumes:
      - osm-status:/status
    networks:
      - tileservers
    restart: on-failure
  
  purge-cache:
    image: "envisionz/omt-tools"
    command: purge-cache
    environment:
      OMT_CACHE_HOST: cache
      OMT_CACHE_ZOOM_MAX: 17
    volumes:
      - omt-expired-tiles:/expired_tiles
    networks:
      - tileservers

  cache:
    image: envisionz/varnish
    environment:
      OMT_CACHE_SIZE: 1G
      OMT_PURGE_HOST: purge-cache
      OMT_CACHE_ZOOM_MAX: 17
    ports:
      - "127.0.0.1:8181:80"
    networks:
      - tileservers
